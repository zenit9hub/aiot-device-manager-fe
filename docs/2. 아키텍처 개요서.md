# 2. 아키텍처 개요서

## 2.1 전체 구조 개요
```mermaid
flowchart LR
  subgraph Client
    FE["Frontend (Vite + Firebase SDK)"]
    MQTTClient[MQTT WebSocket Client]
  end
  subgraph Firebase
    Auth[Firebase Auth]
    Firestore[Firestore]
  end
  subgraph Backend
    API[Express API /api/sensors/data]
    AdminSDK[Firebase Admin SDK]
    Service[Sensor Service Layer]
  end
  subgraph DataLayer
    MySQL[(MySQL\nusers/devices/sensor_readings)]
  end

  MQTTBroker[(MQTT Broker)]

  MQTTBroker --> MQTTClient
  FE --> Auth
  FE --> Firestore
  FE -.ID Token.-> API
  API --> AdminSDK
  AdminSDK --> Auth
  API --> Service --> MySQL
```

## 2.2 레이어별 역할
| 레이어 | 구성 요소 | 책임 |
| --- | --- | --- |
| Presentation | Vite 기반 SPA, MQTT Manager | 사용자 UI, 실시간 메시지 표시, 설정 UI |
| Integration | Firebase SDK, REST Fetch | 인증, Firestore 실시간 데이터, 백엔드 연동 |
| Application | Express Router, 서비스 로직 | 토큰 검증, 사용자/디바이스 Upsert, 오류 처리 |
| Data | MySQL + Schema | 관계형 저장, Append-only 센서 데이터 로그 |

## 2.3 학습 단계별 아키텍처
```mermaid
timeline
  title 단계별 아키텍처 확장
  Phase 1 : Firebase Only (Auth + Firestore)
  Phase 2 : MQTT 연동 및 실시간 차트
  Phase 3 : Express Backend + MySQL 추가
  Phase 4 : 배포 & 운영 자동화 실습
```

## 2.4 데이터 흐름
```mermaid
sequenceDiagram
  participant Device
  participant MQTT as MQTT Broker
  participant FE as Frontend
  participant FB as Firebase Auth
  participant API as Express API
  participant DB as MySQL

  Device->>MQTT: Publish Sensor Data
  MQTT-->>FE: Deliver message
  FE->>FB: Ensure ID Token (refresh if needed)
  FE->>API: POST /api/sensors/data (token + payload)
  API->>FB: verifyIdToken
  API->>DB: Upsert user/device + insert sensor reading
  API-->>FE: 201 Created
```

## 2.5 배포 구조
```mermaid
graph TD
  Dev[로컬 개발 환경] --> Amplify[AWS Amplify Hosting]
  Dev --> DockerCompose["Docker Compose (MySQL)"]
  Amplify --> Users[학습자 브라우저]
  BackendServer[Express 서버] --> DockerCompose
  BackendServer --> MySQLCloud[(클라우드 MySQL 옵션)]
```

## 2.6 확장 포인트
- **분석 파이프라인**: Sensor Readings를 기반으로 BI/Analytics 추가 가능.
- **알림 시스템**: 특정 임계값 초과 시 Firebase Cloud Messaging 등으로 확장.
- **CI/CD**: GitHub Actions → Amplify/Container Registry 파이프라인 연결.
- **서버 확장**: Express → NestJS 전환, RDS로 이관 등.
